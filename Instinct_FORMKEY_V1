<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FormKey v1 â€“ Minimal Intake Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --warn:#f59e0b; --err:#ef4444; --ok:#10b981;
      --br:14px;
    }
    body { margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink); }
    .wrap { max-width:980px; margin:0 auto; padding:24px; }
    .card { background:var(--panel); border:1px solid #1f2937; border-radius:var(--br); padding:20px; box-shadow:0 4px 24px rgba(0,0,0,.25); }
    h1 { font-size:22px; margin:0 0 12px; }
    h2 { font-size:18px; margin:24px 0 8px; color:var(--muted); }
    label { display:block; font-weight:600; margin:12px 0 6px; }
    input, select, textarea {
      width:100%; padding:10px 12px; border:1px solid #374151; border-radius:10px; background:#0b1220; color:var(--ink);
      outline:none;
    }
    textarea { min-height:96px; resize:vertical; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .btns { display:flex; gap:12px; margin-top:16px; }
    button {
      padding:10px 14px; border-radius:10px; border:1px solid transparent; background:var(--accent); color:#052e16; font-weight:700; cursor:pointer;
    }
    button.secondary { background:transparent; color:var(--ink); border-color:#334155; }
    .note { margin-top:8px; color:var(--muted); font-size:14px; }
    .status { margin-top:16px; padding:10px 12px; border-radius:10px; display:none; }
    .status.ok { background:#052e16; color:#a7f3d0; border:1px solid #065f46; }
    .status.err { background:#450a0a; color:#fecaca; border:1px solid #991b1b; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; background:#0b1220; border:1px solid #334155; padding:2px 6px; border-radius:6px; }
    .muted { color:var(--muted); }
    .toggle { display:flex; align-items:center; gap:8px; margin-bottom:12px; }
    /* Modal */
    dialog { width:600px; max-width:calc(100% - 32px); border:none; border-radius:16px; padding:0; background:#0b1220; color:var(--ink); }
    dialog::backdrop { background:rgba(0,0,0,.6); }
    .modal-head { padding:16px 18px; border-bottom:1px solid #1f2937; display:flex; justify-content:space-between; align-items:center; }
    .modal-body { padding:18px; }
    .modal-foot { padding:16px 18px; border-top:1px solid #1f2937; display:flex; justify-content:flex-end; gap:10px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #334155; }
    .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .small { font-size:13px; }
    .hr { height:1px; background:#1f2937; margin:12px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>FormKey v1 â€” Intake Demo</h1>
      <div class="toggle">
        <input type="checkbox" id="mock" />
        <label for="mock" class="muted">Mock mode (simulate API responses)</label>
      </div>

      <div class="row">
        <div>
          <label for="user_id">User ID <span class="muted">(opaque)</span></label>
          <input id="user_id" placeholder="e.g. 7fc9c3d0-1a2b-4e55-9e10-4f7d2a..." />
        </div>
        <div>
          <label for="record_type">Record Type</label>
          <select id="record_type">
            <option value="physiological">physiological</option>
            <option value="behavioral">behavioral</option>
            <option value="environmental">environmental</option>
            <option value="subjective">subjective</option>
          </select>
        </div>
      </div>

      <label for="purpose">Purpose <span class="muted">(10â€“500 chars, human-readable justification)</span></label>
      <textarea id="purpose" placeholder="Example: Daily readiness logging for shift planning context."></textarea>

      <div class="row">
        <div>
          <label for="created_at">Created At <span class="muted">(ISO 8601)</span></label>
          <input id="created_at" type="datetime-local" />
          <div class="note">Must not be a future timestamp.</div>
        </div>
        <div>
          <label for="retention">Retention Policy</label>
          <select id="retention">
            <option value="physio-90d">Physiological default, 90 days</option>
            <option value="behavior-180d">Behavioral default, 180 days</option>
            <option value="env-365d">Environmental default, 365 days</option>
            <option value="subjective-90d">Subjective, 90 days</option>
            <option value="custom">Custom expiry</option>
          </select>
          <div id="customRetWrap" style="display:none; margin-top:8px;">
            <input id="retention_expiry" type="date" />
            <div class="note">If custom, choose a future expiry date.</div>
          </div>
        </div>
      </div>

      <h2>Consent</h2>
      <div class="row">
        <div>
          <label>Consent ID</label>
          <input id="consent_id" placeholder="Will be set after consent" readonly />
          <div class="note">You must capture consent before intake.</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="secondary" id="openConsent">Open Consent Modal</button>
        </div>
      </div>

      <h2>Optional Metadata</h2>
      <div class="row">
        <div>
          <label for="source">Source</label>
          <input id="source" placeholder="e.g. hubbtime-mobile@1.2.3" />
        </div>
        <div>
          <label for="operator">Operator (actor)</label>
          <input id="operator" placeholder="e.g. clerk:PL-ops-02" />
        </div>
      </div>

      <div class="btns">
        <button id="submit">Submit Intake</button>
        <button class="secondary" id="validate">Validate Payload Only</button>
      </div>

      <div id="status" class="status"></div>
    </div>
  </div>

  <!-- Consent Modal -->
  <dialog id="consentModal">
    <div class="modal-head">
      <div style="display:flex; align-items:center; gap:10px;">
        <span class="pill"><span>ðŸ”’</span> Consent</span>
        <strong>Create Consent Record</strong>
      </div>
      <button class="secondary" id="closeConsent">Close</button>
    </div>
    <div class="modal-body">
      <p class="small muted">This establishes explicit consent for this data stream. A unique <span class="kbd">consent_id</span> will be returned and attached to all related records.</p>
      <div class="grid-3">
        <div>
          <label for="c_user">User ID</label>
          <input id="c_user" />
        </div>
        <div>
          <label for="c_scope">Scope</label>
          <select id="c_scope">
            <option value="physiological">physiological</option>
            <option value="behavioral">behavioral</option>
            <option value="environmental">environmental</option>
            <option value="subjective">subjective</option>
          </select>
        </div>
        <div>
          <label for="c_purpose">Purpose Summary</label>
          <input id="c_purpose" placeholder="Short description, 10â€“500 chars" />
        </div>
      </div>
      <div class="hr"></div>
      <label for="c_terms" class="small">
        <input type="checkbox" id="c_terms" />
        I agree to the retention policy and understand I may revoke at any time.
      </label>
    </div>
    <div class="modal-foot">
      <button id="createConsent">Create Consent</button>
    </div>
  </dialog>

  <script>
    // === CONFIG ===
    const API_BASE = "https://api.example.com"; // <-- change to your API base
    const AUTH_TOKEN = "Bearer YOUR_JWT_OR_OAUTH2_TOKEN"; // <-- supply a real token

    // === Helpers ===
    const $ = (id) => document.getElementById(id);
    const show = (el, on=true) => el.style.display = on ? "" : "none";
    const nowIso = () => new Date().toISOString();
    const toIsoFromLocal = (value) => value ? new Date(value).toISOString() : nowIso();

    // Prefill created_at to "now"
    $("created_at").value = new Date().toISOString().slice(0,16);

    // Toggle custom retention input
    $("retention").addEventListener("change", () => {
      show($("customRetWrap"), $("retention").value === "custom");
    });

    // Consent modal wiring
    $("openConsent").addEventListener("click", () => {
      $("c_user").value = $("user_id").value;
      $("c_scope").value = $("record_type").value;
      $("c_purpose").value = $("purpose").value.slice(0, 80);
      $("consentModal").showModal();
    });
    $("closeConsent").addEventListener("click", () => $("consentModal").close());

    // Validation rules (client-side mirror of spec)
    function validateCommonFields({ purpose, created_at, retention, retention_expiry }) {
      if (!purpose || purpose.trim().length < 10 || purpose.trim().length > 500) {
        throw new Error("Purpose must be 10â€“500 characters.");
      }
      if (created_at && new Date(created_at).getTime() > Date.now() + 1000) {
        throw new Error("Created_at must not be in the future.");
      }
      if (retention === "custom") {
        if (!retention_expiry) throw new Error("Custom retention chosen, but no expiry date provided.");
        const d = new Date(retention_expiry);
        if (isNaN(d.getTime()) || d.getTime() <= Date.now()) {
          throw new Error("Retention expiry must be a valid future date.");
        }
      }
    }

    // Build payload
    function buildPayload() {
      const user_id = $("user_id").value.trim();
      const record_type = $("record_type").value;
      const purpose = $("purpose").value.trim();
      const created_at = toIsoFromLocal($("created_at").value);
      const retention = $("retention").value;
      const retention_expiry = retention === "custom" ? new Date($("retention_expiry").value).toISOString() : undefined;
      const consent_id = $("consent_id").value.trim();
      const source = $("source").value.trim();
      const operator = $("operator").value.trim();

      if (!user_id) throw new Error("User ID is required.");
      if (!consent_id) throw new Error("Consent is required. Create a consent_id first.");

      validateCommonFields({ purpose, created_at, retention, retention_expiry });

      // Map retention presets to durations (example)
      const retention_map = {
        "physio-90d": 90,
        "behavior-180d": 180,
        "env-365d": 365,
        "subjective-90d": 90
      };
      const retention_days = retention_map[retention] || undefined;

      // Canonical payload (example minimal)
      const payload = {
        record_id: crypto.randomUUID(),
        user_id,
        record_type,
        purpose,
        created_at,
        consent_id,
        retention_policy: retention_days ? { policy_id: retention, days: retention_days } : undefined,
        retention_expiry: retention_expiry,
        metadata: {
          source: source || "web-demo@1.0.0",
          operator: operator || null,
          app_version: "demo-1.0.0",
          locale: navigator.language || "en-US",
          tz_offset_min: new Date().getTimezoneOffset()
        },
        data: {
          // Put your domain-specific measurement or content here
          sample_value: Math.round(Math.random() * 100),
          unit: "score"
        }
      };

      return payload;
    }

    // Status UI
    function setStatus(msg, ok=false) {
      const el = $("status");
      el.textContent = msg;
      el.className = "status " + (ok ? "ok" : "err");
      el.style.display = "block";
    }

    // Fetch wrapper (respects mock mode)
    async function apiFetch(path, opts = {}) {
      if ($("mock").checked) {
        // Simulated latency
        await new Promise(r => setTimeout(r, 350));
        if (path.startsWith("/consent")) {
          return { ok: true, status: 201, json: async () => ({ consent_id: "CNS-" + crypto.randomUUID(), created_at: nowIso() }) };
        }
        if (path.startsWith("/formkey/v1/intake")) {
          return { ok: true, status: 201, json: async () => ({ record_id: JSON.parse(opts.body).record_id, seal_signature: "v1:simulated", created_at: nowIso() }) };
        }
        if (path.startsWith("/formkey/v1/validate")) {
          return { ok: true, status: 200, json: async () => ({ valid: true }) };
        }
        return { ok: false, status: 404, json: async () => ({ error: "Not found in mock" }) };
      }

      const res = await fetch(API_BASE + path, {
        ...opts,
        headers: {
          "Content-Type": "application/json",
          "Authorization": AUTH_TOKEN,
          ...(opts.headers || {})
        }
      });
      return res;
    }

    // Create Consent
    $("createConsent").addEventListener("click", async () => {
      try {
        const u = $("c_user").value.trim();
        const s = $("c_scope").value;
        const p = $("c_purpose").value.trim();
        const t = $("c_terms").checked;

        if (!u) throw new Error("User ID is required for consent.");
        if (!t) throw new Error("You must accept the terms to proceed.");
        if (p.length < 10 || p.length > 500) throw new Error("Purpose summary must be 10â€“500 characters.");

        const body = JSON.stringify({
          user_id: u,
          scope: s,
          purpose: p
        });

        const res = await apiFetch("/consent", { method: "POST", body });
        const json = await res.json();

        if (!res.ok) throw new Error(json.error || "Consent creation failed.");
        $("consent_id").value = json.consent_id;
        $("consentModal").close();
        setStatus("Consent created: " + json.consent_id, true);
      } catch (e) {
        setStatus(e.message || String(e), false);
      }
    });

    // Validate payload only
    $("validate").addEventListener("click", async () => {
      try {
        const payload = buildPayload();
        // Client validation passed; optionally call server-side validate
        const res = await apiFetch("/formkey/v1/validate", { method: "POST", body: JSON.stringify(payload) });
        const json = await res.json();
        if (!res.ok || json.valid !== true) throw new Error("Server validation failed.");
        setStatus("Payload is valid âœ”", true);
        console.log("Payload:", payload);
      } catch (e) {
        setStatus(e.message || String(e), false);
      }
    });

    // Submit intake
    $("submit").addEventListener("click", async () => {
      try {
        const payload = buildPayload();
        const res = await apiFetch("/formkey/v1/intake", { method: "POST", body: JSON.stringify(payload) });
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || "Intake failed.");
        setStatus(`Intake accepted. Record ${json.record_id} sealed (${json.seal_signature}).`, true);
        console.log("Submitted:", payload);
      } catch (e) {
        setStatus(e.message || String(e), false);
      }
    });
  </script>
</body>
</html>
