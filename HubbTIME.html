/ Building & Grounds": "1000-192-5100-0000",
    "Building & Maintenance": "1000-192-5100-0000",
    "IT / Communications": "1000-129-5100-0000",
    "Cable / PEG Access": "1000-129-5100-0000",
    "Elections": "1000-161-5100-0000",
    "Public Works": "1000-420-5100-0000",
    "Police": "1000-210-5100-0000",
    "Police/Health": "1000-210-5100-0000",
    "Fire": "1000-220-5100-0000",
    "Building": "1000-241-5100-0000",
    "Library": "1000-610-5100-0000",
    "Recreation (Grant)": "1000-129-5100-0000",
    "Senior Center / COA": "1000-541-5100-0000",
    "Senior Center": "1000-541-5100-0000",
    "Senior Center / COA (Grant)": "1000-541-5100-0000",
    "School / Regional Assessment": "1000-129-5100-0000",
    "School Debt/Capital": "1000-129-5100-0000",
    "School Transportation": "1000-129-5100-0000"
  };

  const POSITION_GLS = {
    "Town Administrator": "1000-129-5100-0000",
    "Executive Assistant / Cable Clerk": "1000-122-5100-0000",
    "Town Accountant": "1000-129-5100-0000",
    "Treasurer/Collector": "1000-149-5100-0000",
    "Assistant Treasurer": "1000-149-5100-0000",
    "Chief of Police": "1000-210-5100-0000",
    "Fire Chief": "1000-220-5100-0000",
    "DPW Director": "1000-420-5100-0000",
    "Library Assistant": "1000-610-5100-0000",
    "Inspectional Services Coordinator": "1000-241-5100-0000",
    "COA Director": "1000-541-5100-0000",
    "Building Commissioner": "1000-241-5100-0000",
    "Police Admin / BOH Clerk": "1000-210-5100-0000",
    "Administrative Services Coordinator": "1000-141-5100-0000"
  };

  // Multi-position employees
  const EMPLOYEE_POSITIONS = {
    "PATRICIA LOWE": [
      { title: "Executive Assistant (Select Board)", gl: "1000-122-5100-0000", rate: 23.38, proportion: 26 },
      { title: "Library Assistant", gl: "1000-610-5100-0000", rate: 17.57, proportion: 10 }
    ],
    "LEEANN E MOSES": [
      { title: "Land Use Administrative", gl: "1000-241-5100-0000", proportion: 37 },
      { title: "Assessor Administrative", gl: "1000-141-5100-0000", proportion: 31 }
    ]
  };

  // Auto-allocation for Town Hall Hours
  const AUTO_SPLITS = {
    "PATRICIA LOWE": {
      mode: "weekly",
      targets: [
        { gl: "1000-610-5100-0000", hours: 8.00, label: "Library" },
        { gl: "1000-122-5100-0000", hours: 26.00, label: "Select Board" }
      ]
    },
    "LEEANN E MOSES": {
      mode: "biweekly", 
      targets: [
        { gl: "1000-241-5100-0000", hours: 37.00, label: "Land Use" },
        { gl: "1000-141-5100-0000", hours: 31.00, label: "Assessors" }
      ]
    }
  };

  // GL accounts available for split
  const GL_ACCOUNT_OPTIONS = [
    { value: "1000-122-5100-0000", label: "Select Board" },
    { value: "1000-129-5100-0000", label: "Administration" },
    { value: "1000-141-5100-0000", label: "Assessors" },
    { value: "1000-149-5100-0000", label: "Treasurer/Collector" },
    { value: "1000-161-5100-0000", label: "Town Clerk" },
    { value: "1000-192-5100-0000", label: "Facilities" },
    { value: "1000-210-5100-0000", label: "Police" },
    { value: "1000-220-5100-0000", label: "Fire" },
    { value: "1000-241-5100-0000", label: "Land Use/Building" },
    { value: "1000-420-5100-0000", label: "Public Works" },
    { value: "1000-541-5100-0000", label: "Senior Center/COA" },
    { value: "1000-610-5100-0000", label: "Library" }
  ];

  // ---- State Variables ----
  let currentEmployee = null;
  let currentWarrant = null;
  let autoSaveTimeout = null;
  let glSplitAllocations = [];

  // ---- Utility Functions ----
  const $ = s => document.querySelector(s);
  const currency = n =>new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(n || 0));
  
  function setMsg(text, type = 'info', show = true) {
    const el = $('#systemMsg');
    if (!el) return;
    if (!show) { 
      el.style.display = 'none'; 
      return; 
    }
    el.className = 'alert ' + type;
    el.textContent = text;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
  }

  function timeDiffHours(start, end) {
    if (!start || !end) return 0;
    const [sh, sm] = start.split(':').map(Number);
    const [eh, em] = end.split(':').map(Number);
    let s = sh * 60 + sm, e = eh * 60 + em;
    if (e < s) e += 24 * 60; // overnight
    return Math.round(((e - s) / 60) * 100) / 100;
  }

  function getWeekIndex(dateStr) {
    if (!currentWarrant || !dateStr) return 1;
    const start = new Date(currentWarrant.start + 'T00:00:00');
    const d = new Date(dateStr + 'T00:00:00');
    const diffDays = Math.floor((d - start) / 86400000);
    return diffDays < 7 ? 1 : 2;
  }

  function showAutoSave() {
    const indicator = $('#autoSaveIndicator');
    if (indicator) {
      indicator.style.opacity = '1';
      setTimeout(() => indicator.style.opacity = '0', 2000);
    }
  }

  // ---- GL Split Management ----
  function showGLSplitSection() {
    const card = $('#glSplitCard');
    if (card) card.style.display = 'block';
  }

  function hideGLSplitSection() {
    const card = $('#glSplitCard');
    if (card) card.style.display = 'none';
    glSplitAllocations = [];
  }

  function initializeGLSplit() {
    const container = $('#glSplitContainer');
    if (!container) return;
    
    container.innerHTML = '';
    glSplitAllocations = [];
    addGLSplitRow();
  }

  function addGLSplitRow() {
    const container = $('#glSplitContainer');
    if (!container) return;

    const rowDiv = document.createElement('div');
    rowDiv.className = 'gl-split-row';
    
    const rowId = 'gl-split-' + Date.now();
    
    rowDiv.innerHTML = `
      <label style="font-weight: 600;">GL Account:</label>
      <select class="gl-split-account input" data-row-id="${rowId}" required>
        <option value="">-- Select Account --</option>
        ${GL_ACCOUNT_OPTIONS.map(opt => `<option value="${opt.value}">${opt.label} — ${opt.value}</option>`).join('')}
      </select>
      <label style="font-weight: 600;">Hours:</label>
      <input type="number" class="gl-split-hours input" data-row-id="${rowId}" step="0.25" min="0" placeholder="0.00" required />
      <button type="button" class="btn danger" style="padding: 6px 12px; font-size: 0.85rem;" onclick="window.HubbTIME.removeGLSplitRow('${rowId}')">Remove</button>
    `;

    container.appendChild(rowDiv);
    
    // Wire up event listeners
    const accountSelect = rowDiv.querySelector('.gl-split-account');
    const hoursInput = rowDiv.querySelector('.gl-split-hours');
    
    accountSelect.addEventListener('change', validateGLSplit);
    hoursInput.addEventListener('input', validateGLSplit);
    
    validateGLSplit();
  }

  function removeGLSplitRow(rowId) {
    const container = $('#glSplitContainer');
    if (!container) return;
    
    const rows = container.querySelectorAll('.gl-split-row');
    if (rows.length <= 1) {
      setMsg('You must have at least one GL account allocation.', 'warning', true);
      return;
    }
    
    const row = container.querySelector(`[data-row-id="${rowId}"]`)?.closest('.gl-split-row');
    if (row) {
      row.remove();
      validateGLSplit();
    }
  }

  function calculateGLSplitTotals() {
    let totalAllocated = 0;
    const allocations = [];
    
    const container = $('#glSplitContainer');
    if (!container) return { totalAllocated: 0, allocations: [] };
    
    const rows = container.querySelectorAll('.gl-split-row');
    rows.forEach(row => {
      const account = row.querySelector('.gl-split-account')?.value || '';
      const hours = parseFloat(row.querySelector('.gl-split-hours')?.value || 0) || 0;
      
      if (account && hours > 0) {
        totalAllocated += hours;
        allocations.push({ account, hours });
      }
    });
    
    return { totalAllocated, allocations };
  }

  function validateGLSplit() {
    const totalHoursEl = $('#totalHours');
    const totalHours = parseFloat(totalHoursEl?.textContent || 0) || 0;
    
    const { totalAllocated, allocations } = calculateGLSplitTotals();
    
    // Update display
    const glSplitTotalHoursEl = $('#glSplitTotalHours');
    const glAllocatedHoursEl = $('#glAllocatedHours');
    const glTotalHoursEl = $('#glTotalHours');
    const glStatusEl = $('#glSplitStatus');
    const glStatusIconEl = $('#glStatusIcon');
    const glStatusTextEl = $('#glStatusText');
    
    if (glSplitTotalHoursEl) glSplitTotalHoursEl.textContent = totalHours.toFixed(2);
    if (glAllocatedHoursEl) glAllocatedHoursEl.textContent = totalAllocated.toFixed(2);
    if (glTotalHoursEl) glTotalHoursEl.textContent = totalHours.toFixed(2);
    
    glSplitAllocations = allocations;
    
    if (!glStatusEl) return false;
    
    const diff = Math.abs(totalAllocated - totalHours);
    const isValid = diff < 0.01 && totalHours > 0;
    
    if (isValid) {
      glStatusEl.className = 'gl-split-status valid';
      if (glStatusIconEl) glStatusIconEl.textContent = '✓';
      if (glStatusTextEl) glStatusTextEl.textContent = 'Perfect! All hours allocated correctly.';
      return true;
    } else if (totalAllocated > totalHours) {
      glStatusEl.className = 'gl-split-status over';
      if (glStatusIconEl) glStatusIconEl.textContent = '✗';
      if (glStatusTextEl) glStatusTextEl.textContent = `Over-allocated by ${(totalAllocated - totalHours).toFixed(2)} hours. Please adjust.`;
      return false;
    } else {
      glStatusEl.className = 'gl-split-status under';
      if (glStatusIconEl) glStatusIconEl.textContent = '⚠️';
      if (glStatusTextEl) glStatusTextEl.textContent = totalHours > 0 
        ? `Under-allocated by ${(totalHours - totalAllocated).toFixed(2)} hours. Please add more.`
        : 'Please allocate all hours before submitting.';
      return false;
    }
  }

  // ---- GL Code Management ----
  function getDefaultGL(emp) {
    if (!emp) return "";
    if (emp.position && POSITION_GLS[emp.position]) return POSITION_GLS[emp.position];
    if (DEPT_GLS[emp.department]) return DEPT_GLS[emp.department];
    return "";
  }

  function getEmployeeGLChoices(emp) {
    if (!emp) return [];
    const choices = (EMPLOYEE_POSITIONS[emp.name] || []).map(x => ({ 
      label: `${x.title} — ${x.gl}`, 
      value: x.gl 
    }));

    if (emp.position && POSITION_GLS[emp.position]) {
      const gl = POSITION_GLS[emp.position];
      if (!choices.some(c => c.value === gl)) {
        choices.push({ label: `Position (${emp.position}) — ${gl}`, value: gl });
      }
    }

    const deptGL = DEPT_GLS[emp.department];
    if (deptGL && !choices.some(c => c.value === deptGL)) {
      choices.push({ label: `Department (${emp.department}) — ${deptGL}`, value: deptGL });
    }

    const seen = new Set();
    return choices.filter(c => (seen.has(c.value) ? false : seen.add(c.value)));
  }

  function rebuildGLDatalistFor(emp) {
    let dl = document.getElementById('glList');
    if (!dl) {
      dl = document.createElement('datalist');
      dl.id = 'glList';
      document.body.appendChild(dl);
    }
    dl.innerHTML = '';
    
    if (emp) {
      const choices = getEmployeeGLChoices(emp);
      choices.forEach(choice => {
        const option = document.createElement('option');
        option.value = choice.value;
        option.label = choice.label;
        dl.appendChild(option);
      });
    }
  }

  function createGLInput(initialGL = '', emp = null) {
    const hasMulti = emp && EMPLOYEE_POSITIONS[emp.name] && EMPLOYEE_POSITIONS[emp.name].length;
    
    const glDiv = document.createElement('div');
    glDiv.className = 'gl-cell';
    glDiv.style.display = 'none'; // Hidden for Leeanne and Patricia
    
    const glInput = document.createElement('input');
    glInput.type = 'text';
    glInput.setAttribute('list', 'glList');
    glInput.className = 'gl-input input';
    glInput.placeholder = 'Type GL code...';
    glInput.value = initialGL || getDefaultGL(emp);
    glInput.style.minWidth = '15ch';
    glInput.setAttribute('autocomplete', 'off');
    
    glDiv.appendChild(glInput);
    
    // Add multi-position dropdown for special employees
    if (hasMulti) {
      const glChooser = document.createElement('select');
      glChooser.className = 'gl-chooser input';
      glChooser.style.marginTop = '4px';
      glChooser.style.fontSize = '12px';
      
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '↓ Quick select role';
      glChooser.appendChild(defaultOption);
      
      EMPLOYEE_POSITIONS[emp.name].forEach(position => {
        const option = document.createElement('option');
        option.value = position.gl;
        const rateText = position.rate ? ` @ $${position.rate}/hr` : '';
        const proportionText = position.proportion ? ` (${position.proportion} parts)` : '';
        option.textContent = `${position.title}${rateText}${proportionText}`;
        glChooser.appendChild(option);
      });
      
      glChooser.addEventListener('change', function() {
        if (this.value) {
          glInput.value = this.value;
          glInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });
      
      glDiv.appendChild(glChooser);
    }
    
    return glDiv;
  }

  // ---- Employee Management ----
  function handleEmployeeSelection(e) {
    const name = (e.target.value || '').trim();
    const emp = EMPLOYEES.find(x => x.name.toLowerCase() === name.toLowerCase());
    if (!emp) return;
    
    currentEmployee = emp;
    
    const details = $('#employeeDetails');
    if (details) details.style.display = 'block';
    
    const dep = $('#department'); 
    if (dep) dep.textContent = emp.department || '—';
    
    const pty = $('#payType');    
    if (pty) pty.textContent = emp.payType ? (emp.payType[0].toUpperCase() + emp.payType.slice(1)) : '—';
    
    const rate = $('#rate');
    if (rate) {
      rate.textContent = emp.payType === 'salary'
        ? (emp.rate ? (currency(emp.rate) + ' annually') : '—')
        : (emp.rate ? (currency(emp.rate) + ' per hour') : '—');
    }

    rebuildGLDatalistFor(emp);
    reseedBlankGLs();
    
    // Show/hide GL split section for Leeanne and Patricia
    if (GL_SPLIT_EMPLOYEES.includes(emp.name)) {
      showGLSplitSection();
      initializeGLSplit();
      hideGLColumnInTable();
      setMsg(`${emp.name}: GL account split enabled. You'll allocate hours by account at the bottom of the form.`, 'info', true);
    } else {
      hideGLSplitSection();
      showGLColumnInTable();
    }
    
    calculateTotals();
    
    // Show message about multi-position functionality
    if (EMPLOYEE_POSITIONS[emp.name]) {
      const positions = EMPLOYEE_POSITIONS[emp.name];
      const positionText = positions.map(p => `${p.title} (${p.proportion} parts)`).join(' & ');
      setMsg(`${emp.name} has multiple positions: ${positionText}. Quick day buttons will auto-split hours.`, 'info', true);
    }
  }

  function hideGLColumnInTable() {
    const headers = document.querySelectorAll('th');
    headers.forEach(th => {
      if (th.textContent.trim() === 'GL Code') {
        th.style.display = 'none';
      }
    });
  }

  function showGLColumnInTable() {
    const headers = document.querySelectorAll('th');
    headers.forEach(th => {
      if (th.textContent.trim() === 'GL Code') {
        th.style.display = '';
      }
    });
  }

  function clearEmployee() {
    currentEmployee = null;
    ['employeeIndex','employeeSearch'].forEach(id => { 
      const el = document.getElementById(id); 
      if (el) el.value = ''; 
    });
    ['department','payType','rate'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.textContent = '—';
    });
    const details = $('#employeeDetails');
    if (details) details.style.display = 'none';
    
    const dl = document.getElementById('glList'); 
    if (dl) dl.innerHTML = '';
    
    hideGLSplitSection();
    showGLColumnInTable();
    calculateTotals();
  }

  function reseedBlankGLs() {
    const rows = Array.from(document.querySelectorAll('#timeBody tr'));
    const def = getDefaultGL(currentEmployee);
    rows.forEach(r => {
      const glIn = r.querySelector('.gl-input');
      if (glIn && !glIn.value && def) glIn.value = def;
    });
  }

  // ---- Time Entry Management ----
  function addTimeRowWith(date, start, end, hours, type, glCode, description) {
    const tbody = $('#timeBody'); 
    if (!tbody) return;

    const tr = document.createElement('tr');
    
    const isGLSplitEmployee = currentEmployee && GL_SPLIT_EMPLOYEES.includes(currentEmployee.name);
    
    tr.innerHTML =
      `<td><input type="date" class="date-cell input" value="${date || ''}"></td>
       <td><input type="time" class="time-start input" value="${start || ''}"></td>
       <td><input type="time" class="time-end input" value="${end || ''}"></td>
       <td><input type="number" step="0.25" min="0" placeholder="0.00" class="time-hours input" value="${hours || ''}"></td>
       <td>
         <select class="time-type input">
           <option${type==='Regular'?' selected':''}>Regular</option>
           <option${type==='Sick'?' selected':''}>Sick</option>
           <option${type==='Personal'?' selected':''}>Personal</option>
           <option${type==='Vacation'?' selected':''}>Vacation</option>
           <option${type==='Holiday'?' selected':''}>Holiday</option>
         </select>
       </td>
       <td style="${isGLSplitEmployee ? 'display:none;' : ''}"></td>
       <td><input type="text" class="input" placeholder="Describe work or leave" value="${description || ''}"></td>
       <td>
         <div class="row-actions">
           <button type="button" class="row-btn insert-above">↑ Above</button>
           <button type="button" class="row-btn insert-below">↓ Below</button>
           <button type="button" class="row-btn remove-row" style="background: var(--error); color: white;">Remove</button>
         </div>
       </td>`;

    // Insert the custom GL cell (hidden for GL split employees)
    const glCell = tr.children[5];
    const glInput = createGLInput(glCode || getDefaultGL(currentEmployee), currentEmployee);
    glCell.appendChild(glInput);

    tbody.appendChild(tr);

    if (start && end && type === 'Regular') {
      tr.querySelector('.time-hours').value = timeDiffHours(start, end).toFixed(2);
    }

    wireRowEvents(tr);
    return tr;
  }

  function wireRowEvents(tr) {
    tr.querySelector('.remove-row').addEventListener('click', () => { 
      tr.remove(); 
      calculateTotals(); 
      scheduleAutoSave();
    });

    tr.querySelector('.insert-above').addEventListener('click', () => insertRow(tr, 'above'));
    tr.querySelector('.insert-below').addEventListener('click', () => insertRow(tr, 'below'));
    
    tr.querySelectorAll('input, select').forEach(inp => {
      inp.addEventListener('input', function () {
        const rowType = tr.querySelector('.time-type')?.value || 'Regular';
        if ((this.classList.contains('time-start') || this.classList.contains('time-end')) && rowType === 'Regular') {
          const s = tr.querySelector('.time-start')?.value || '';
          const e = tr.querySelector('.time-end')?.value || '';
          if (s && e) tr.querySelector('.time-hours').value = timeDiffHours(s, e).toFixed(2);
        }
        calculateTotals();
        scheduleAutoSave();
      });
    });
  }

  function insertRow(tr, position) {
    const newRow = document.createElement('tr');
    newRow.innerHTML = tr.innerHTML;
    
    newRow.querySelectorAll('input').forEach(input => {
      if (input.type === 'date') {
        input.value = tr.querySelector('.date-cell').value;
      } else if (input.classList.contains('gl-input')) {
        input.value = tr.querySelector('.gl-input').value;
      } else {
        input.value = '';
      }
    });
    
    newRow.querySelectorAll('select').forEach(select => {
      if (select.classList.contains('time-type')) {
        select.value = tr.querySelector('.time-type').value;
      } else {
        select.selectedIndex = 0;
      }
    });

    const glCell = newRow.children[5];
    glCell.innerHTML = '';
    const glInput = createGLInput(tr.querySelector('.gl-input').value, currentEmployee);
    glCell.appendChild(glInput);

    if (position === 'above') {
      tr.parentNode.insertBefore(newRow, tr);
    } else {
      tr.parentNode.insertBefore(newRow, tr.nextSibling);
    }
    
    wireRowEvents(newRow);
    calculateTotals();
  }

  function addTimeRow() {
    const seedGL = getDefaultGL(currentEmployee);
    addTimeRowWith('', '', '', '', 'Regular', seedGL, '');
  }

  function clearAllRows() {
    const tb = $('#timeBody'); 
    if (tb) tb.innerHTML = '';
    calculateTotals();
  }

  // ---- Quick Actions ----
  function addQuickDay(kind, label, defaultHours = '8.00') {
    if (!currentEmployee) {
      setMsg('Please select an employee first.', 'error', true);
      return;
    }
    const today = new Date().toISOString().slice(0, 10);
    
    // Auto-split hours for multi-position employees (but not GL split employees)
    if (EMPLOYEE_POSITIONS[currentEmployee.name] && !GL_SPLIT_EMPLOYEES.includes(currentEmployee.name)) {
      const positions = EMPLOYEE_POSITIONS[currentEmployee.name];
      const totalParts = positions.reduce((sum, pos) => sum + pos.proportion, 0);
      const totalHours = parseFloat(defaultHours);
      
      positions.forEach((position) => {
        const proportionalHours = (totalHours * position.proportion / totalParts).toFixed(2);
        const positionLabel = `${label} (${position.title})`;
        addTimeRowWith(today, '', '', proportionalHours, kind, position.gl, positionLabel);
      });
      
      calculateTotals();
      setMsg(`${label} split: ${positions.map(p => `${(parseFloat(defaultHours) * p.proportion / totalParts).toFixed(2)}h ${p.title}`).join(' + ')}`, 'success', true);
    } else {
      // Regular single-position employee or GL split employee
      const gl = getDefaultGL(currentEmployee);
      addTimeRowWith(today, '', '', defaultHours, kind, gl, label);
      calculateTotals();
      setMsg(`${label} added successfully.`, 'success', true);
    }
    scheduleAutoSave();
  }

  function addSplitShift() {
    const tbody = document.getElementById('timeBody');
    if (!tbody || tbody.children.length === 0) {
      setMsg('Add a time entry first before splitting shifts.', 'error', true);
      return;
    }

    const lastRow = tbody.children[tbody.children.length - 1];
    const date = lastRow.querySelector('.date-cell')?.value || '';
    const start = lastRow.querySelector('.time-start')?.value || '';
    const end = lastRow.querySelector('.time-end')?.value || '';
    const gl = lastRow.querySelector('.gl-input')?.value || getDefaultGL(currentEmployee);
    const type = lastRow.querySelector('.time-type')?.value || 'Regular';
    const desc = lastRow.children[6]?.querySelector('input')?.value || '';
    
    if (!date || !start || !end) {
      setMsg('Please complete the date, start time, and end time in the last row first.', 'error', true);
      return;
    }

    if (type !== 'Regular') {
      setMsg('Split Shift only works with Regular time entries.', 'error', true);
      return;
    }

    const hhmmToMin = (hhmm) => {
      if (!hhmm) return null;
      const [h, m] = hhmm.split(':').map(Number);
      return h * 60 + m;
    };

    const minToHHMM = (mins) => {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    };

    const s = hhmmToMin(start);
    const e = hhmmToMin(end);
    
    if (s == null || e == null || e <= s) {
      setMsg('Invalid time range. End time must be after start time.', 'error', true);
      return;
    }

    const mid = Math.floor((s + e) / 2);
    const midTime = minToHHMM(mid);

    lastRow.remove();
    addTimeRowWith(date, start, midTime, '', 'Regular', gl, `${desc} (Split 1/2)`.trim());
    addTimeRowWith(date, midTime, end, '', 'Regular', gl, `${desc} (Split 2/2)`.trim());

    calculateTotals();
    setMsg(`Shift split successfully: ${start}-${midTime} and ${midTime}-${end}`, 'success', true);
    scheduleAutoSave();
  }

  function addTownHallHours() {
    if (!currentWarrant) { 
      setMsg("Select a pay period first.", "info", true); 
      return; 
    }
    clearAllRows();
    const start = new Date(currentWarrant.start + 'T00:00:00');
    const end = new Date(currentWarrant.end + 'T00:00:00');

    // Mon/Wed/Thu 8-4, Tuesday 8-6
    const schedule = {
      1: { start: "08:00", end: "16:00" }, // Monday
      2: { start: "08:00", end: "18:00" }, // Tuesday
      3: { start: "08:00", end: "16:00" }, // Wednesday
      4: { start: "08:00", end: "16:00" }  // Thursday
    };

    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      const dow = d.getDay();
      if (schedule[dow]) {
        const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        addTimeRowWith(iso, schedule[dow].start, schedule[dow].end, '', 'Regular', getDefaultGL(currentEmployee), 'Town Hall hours');
      }
    }
    calculateTotals();
    setMsg(`Town Hall hours template applied for ${currentWarrant.start} to ${currentWarrant.end} (M/W/Th 8-4, Tu 8-6).`, "success", true);

    // Auto-allocation for specific employees (but not GL split employees)
    if (currentEmployee && AUTO_SPLITS[currentEmployee.name] && !GL_SPLIT_EMPLOYEES.includes(currentEmployee.name)) {
      const splitConfig = AUTO_SPLITS[currentEmployee.name];
      const allRows = Array.from(document.querySelectorAll('#timeBody tr'));
      const regularRows = allRows.filter(row => {
        const type = row.querySelector('.time-type')?.value || 'Regular';
        return type === 'Regular';
      });
      
      if (splitConfig.mode === "weekly") {
        const week1Rows = regularRows.filter(row => {
          const date = row.querySelector('.date-cell')?.value || '';
          return getWeekIndex(date) === 1;
        });
        const week2Rows = regularRows.filter(row => {
          const date = row.querySelector('.date-cell')?.value || '';
          return getWeekIndex(date) === 2;
        });
        
        allocateHoursToTargets(week1Rows, splitConfig.targets);
        allocateHoursToTargets(week2Rows, splitConfig.targets);
      } else if (splitConfig.mode === "biweekly") {
        allocateHoursToTargets(regularRows, splitConfig.targets);
      }
      
      calculateTotals();
      const targetSummary = splitConfig.targets.map(t => `${t.hours}h ${t.label}`).join(' + ');
      setMsg(`Town Hall hours allocated for ${currentEmployee.name}: ${targetSummary} ${splitConfig.mode === 'weekly' ? 'per week' : 'total'}.`, "success", true);
    }
    scheduleAutoSave();
  }

  function allocateHoursToTargets(rows, targets) {
    if (!rows.length || !targets.length) return;
    
    let currentTargetIndex = 0;
    let remainingHours = targets[currentTargetIndex].hours;
    const tbody = document.getElementById('timeBody');
    
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const hoursInput = row.querySelector('.time-hours');
      const rowHours = parseFloat(hoursInput?.value || 0);
      
      if (rowHours <= 0) continue;
      if (currentTargetIndex >= targets.length) continue;
      
      const currentTarget = targets[currentTargetIndex];
      
      if (rowHours <= remainingHours) {
        const glInput = row.querySelector('.gl-input');
        if (glInput) glInput.value = currentTarget.gl;
        remainingHours -= rowHours;
        
        if (remainingHours <= 0.01) {
          currentTargetIndex++;
          if (currentTargetIndex < targets.length) {
            remainingHours = targets[currentTargetIndex].hours;
          }
        }
      } else {
        const date = row.querySelector('.date-cell')?.value || '';
        const type = row.querySelector('.time-type')?.value || 'Regular';
        const desc = row.children[6]?.querySelector('input')?.value || '';
        
        const glInput = row.querySelector('.gl-input');
        if (glInput) glInput.value = currentTarget.gl;
        hoursInput.value = remainingHours.toFixed(2);
        
        const startInput = row.querySelector('.time-start');
        const endInput = row.querySelector('.time-end');
        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        
        const leftoverHours = rowHours - remainingHours;
        currentTargetIndex++;
        
        if (currentTargetIndex < targets.length) {
          const nextTarget = targets[currentTargetIndex];
          const newRow = addTimeRowWith(date, '', '', leftoverHours.toFixed(2), type, nextTarget.gl, desc);
          
          if (row.nextSibling) {
            tbody.insertBefore(newRow, row.nextSibling);
          } else {
            tbody.appendChild(newRow);
          }
          
          remainingHours = targets[currentTargetIndex].hours - leftoverHours;
          if (remainingHours <= 0.01) {
            currentTargetIndex++;
            if (currentTargetIndex < targets.length) {
              remainingHours = targets[currentTargetIndex].hours;
            }
          }
        } else {
          const defaultGL = getDefaultGL(currentEmployee);
          const newRow = addTimeRowWith(date, '', '', leftoverHours.toFixed(2), type, defaultGL, desc);
          
          if (row.nextSibling) {
            tbody.insertBefore(newRow, row.nextSibling);
          } else {
            tbody.appendChild(newRow);
          }
        }
      }
    }
  }

  // ---- Calculations ----
  function calculateTotals() {
    let totalHours = 0, reg = 0, sick = 0, pers = 0, vac = 0, hol = 0;
    let w1Reg = 0, w2Reg = 0;

    const rows = Array.from(document.querySelectorAll('#timeBody tr'));
    rows.forEach(row => {
      const date = row.querySelector('.date-cell')?.value || '';
      const hours = parseFloat(row.querySelector('.time-hours')?.value || 0) || 0;
      const type = row.querySelector('.time-type')?.value || 'Regular';
      if (!hours) return;
      totalHours += hours;
      if (type === 'Regular') {
        reg += hours;
        const wk = getWeekIndex(date);
        if (wk === 1) w1Reg += hours; else w2Reg += hours;
      } else if (type === 'Sick') sick += hours;
      else if (type === 'Personal') pers += hours;
      else if (type === 'Vacation') vac += hours;
      else if (type === 'Holiday') hol += hours;
    });

    // Overtime calculation
    let overtime = 0;
    let regPayable = reg;
    if (currentEmployee && currentEmployee.payType === 'hourly') {
      const w1OT = Math.max(0, w1Reg - 40);
      const w2OT = Math.max(0, w2Reg - 40);
      overtime = w1OT + w2OT;
      regPayable = Math.max(0, reg - overtime);
    }

    // Update display
    const setTxt = (id, v) => { 
      const el = document.getElementById(id); 
      if (el) el.textContent = v.toFixed(2); 
    };
    setTxt('totalHours', totalHours);
    setTxt('sumRegular', regPayable);
    setTxt('sumSick', sick);
    setTxt('sumPersonal', pers);
    setTxt('sumVacation', vac);
    setTxt('sumHoliday', hol);

    // Pay calculation with multi-position rate support
    let gross = 0;
    if (currentEmployee && currentEmployee.rate) {
      if (currentEmployee.payType === 'hourly') {
        // For GL split employees, use split allocations
        if (GL_SPLIT_EMPLOYEES.includes(currentEmployee.name) && glSplitAllocations.length > 0) {
          let totalPay = 0;
          glSplitAllocations.forEach(alloc => {
            const position = EMPLOYEE_POSITIONS[currentEmployee.name]?.find(pos => pos.gl === alloc.account);
            const rate = position && position.rate ? position.rate : currentEmployee.rate;
            totalPay += alloc.hours * rate;
          });
          gross = totalPay;
        } else {
          const hasPositionRates = currentEmployee.name && EMPLOYEE_POSITIONS[currentEmployee.name] && 
                                  EMPLOYEE_POSITIONS[currentEmployee.name].some(pos => pos.rate);
          if (hasPositionRates) {
            let totalPay = 0;
            rows.forEach(row => {
              const hours = parseFloat(row.querySelector('.time-hours')?.value || 0) || 0;
              const gl = row.querySelector('.gl-input')?.value || '';
              if (hours > 0) {
                const position = EMPLOYEE_POSITIONS[currentEmployee.name].find(pos => pos.gl === gl);
                const rate = position && position.rate ? position.rate : currentEmployee.rate;
                totalPay += hours * rate;
              }
            });
            gross = totalPay;
          } else {
            const r = currentEmployee.rate;
            const regPay = regPayable * r;
            const otPay  = overtime * r * 1.5;
            const leavePay = (sick + pers + vac + hol) * r;
            gross = regPay + otPay + leavePay;
          }
        }
      } else if (currentEmployee.payType === 'salary') {
        gross = currentEmployee.rate / 26; // biweekly
      }
    }
    const gp = document.getElementById('grossPay'); 
    if (gp) gp.textContent = currency(gross);
    
    updateGLReview();
    
    // Validate GL split if applicable
    if (currentEmployee && GL_SPLIT_EMPLOYEES.includes(currentEmployee.name)) {
      validateGLSplit();
    }
  }

  function updateGLReview() {
    const glBreakdown = {};
    
    // For GL split employees, use their split allocations
    if (currentEmployee && GL_SPLIT_EMPLOYEES.includes(currentEmployee.name) && glSplitAllocations.length > 0) {
      glSplitAllocations.forEach(alloc => {
        if (!glBreakdown[alloc.account]) {
          glBreakdown[alloc.account] = { regular: 0, sick: 0, personal: 0, vacation: 0, holiday: 0, total: 0 };
        }
        // Assume all split hours are regular for now
        glBreakdown[alloc.account].regular += alloc.hours;
        glBreakdown[alloc.account].total += alloc.hours;
      });
    } else {
      // Regular employees - use GL codes from rows
      const rows = Array.from(document.querySelectorAll('#timeBody tr'));
      
      rows.forEach(row => {
        const hours = parseFloat(row.querySelector('.time-hours')?.value || 0) || 0;
        const type = row.querySelector('.time-type')?.value || 'Regular';
        const gl = row.querySelector('.gl-input')?.value || '';
        
        if (hours > 0 && gl) {
          if (!glBreakdown[gl]) {
            glBreakdown[gl] = { regular: 0, sick: 0, personal: 0, vacation: 0, holiday: 0, total: 0 };
          }
          glBreakdown[gl][type.toLowerCase()] += hours;
          glBreakdown[gl].total += hours;
        }
      });
    }

    const reviewWrap = $('#glReviewWrap');
    if (!reviewWrap) return;

    if (Object.keys(glBreakdown).length === 0) {
      reviewWrap.innerHTML = `
        <p class="text-center text-muted" style="padding:var(--space-xl);">
          Enter time entries above to see GL code breakdown and cost allocation
        </p>`;
      return;
    }

    let costCalculation = '';
    if (currentEmployee && currentEmployee.rate) {
      costCalculation = currentEmployee.payType === 'hourly' 
        ? `<th>Regular Cost</th><th>Leave Cost</th><th>Total Cost</th>`
        : `<th>Salary Allocation</th>`;
    }

    let tableHTML = `
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>GL Code</th>
              <th>Regular</th>
              <th>Sick</th>
              <th>Personal</th>
              <th>Vacation</th>
              <th>Holiday</th>
              <th>Total Hours</th>
              ${costCalculation}
            </tr>
          </thead>
          <tbody>`;

    Object.entries(glBreakdown).forEach(([gl, breakdown]) => {
      let costCells = '';
      if (currentEmployee && currentEmployee.rate) {
        if (currentEmployee.payType === 'hourly') {
          let rate = currentEmployee.rate;
          if (currentEmployee.name && EMPLOYEE_POSITIONS[currentEmployee.name]) {
            const position = EMPLOYEE_POSITIONS[currentEmployee.name].find(pos => pos.gl === gl && pos.rate);
            if (position) rate = position.rate;
          }
          const regularCost = breakdown.regular * rate;
          const leaveCost = (breakdown.sick + breakdown.personal + breakdown.vacation + breakdown.holiday) * rate;
          const totalCost = regularCost + leaveCost;
          costCells = `
            <td>${currency(regularCost)}</td>
            <td>${currency(leaveCost)}</td>
            <td><strong>${currency(totalCost)}</strong></td>`;
        } else {
          const totalHours = Object.values(glBreakdown).reduce((sum, b) => sum + b.total, 0);
          const allocation = totalHours > 0 ? (breakdown.total / totalHours) * (currentEmployee.rate / 26) : 0;
          costCells = `<td><strong>${currency(allocation)}</strong></td>`;
        }
      }

      tableHTML += `
        <tr>
          <td><strong>${gl}</strong></td>
          <td>${breakdown.regular.toFixed(2)}</td>
          <td>${breakdown.sick.toFixed(2)}</td>
          <td>${breakdown.personal.toFixed(2)}</td>
          <td>${breakdown.vacation.toFixed(2)}</td>
          <td>${breakdown.holiday.toFixed(2)}</td>
          <td><strong>${breakdown.total.toFixed(2)}</strong></td>
          ${costCells}
        </tr>`;
    });

    tableHTML += `</tbody></table></div>`;
    reviewWrap.innerHTML = tableHTML;
  }

  // ---- Auto-save ----
  function scheduleAutoSave() {
    if (autoSaveTimeout) {
      clearTimeout(autoSaveTimeout);
    }
    autoSaveTimeout = setTimeout(() => {
      saveToLocalStorage();
      showAutoSave();
    }, 2000);
  }

  function saveToLocalStorage() {
    const rows = Array.from(document.querySelectorAll('#timeBody tr'));
    const entries = rows.map(row => ({
      date: row.querySelector('.date-cell')?.value || '',
      start: row.querySelector('.time-start')?.value || '',
      end: row.querySelector('.time-end')?.value || '',
      hours: row.querySelector('.time-hours')?.value || '',
      type: row.querySelector('.time-type')?.value || 'Regular',
      gl: row.querySelector('.gl-input')?.value || '',
      description: row.children[6]?.querySelector('input')?.value || ''
    }));

    const data = {
      currentEmployee: currentEmployee,
      entries: entries,
      warrant: $('#warrant')?.value || '',
      glSplitAllocations: glSplitAllocations,
      timestamp: Date.now()
    };
    
    try {
      localStorage.setItem('hubbtime_data', JSON.stringify(data));
    } catch (error) {
      console.error('Error saving to localStorage:', error);
    }
  }

  function loadFromLocalStorage() {
    try {
      const saved = localStorage.getItem('hubbtime_data');
      if (saved) {
        const data = JSON.parse(saved);
        
        if (data.currentEmployee) {
          currentEmployee = data.currentEmployee;
          const empSearch = $('#employeeSearch');
          if (empSearch) {
            empSearch.value = data.currentEmployee.name;
            handleEmployeeSelection({ target: empSearch });
          }
        }
        
        if (data.entries && Array.isArray(data.entries)) {
          data.entries.forEach(entry => {
            addTimeRowWith(entry.date, entry.start, entry.end, entry.hours, entry.type, entry.gl, entry.description);
          });
          calculateTotals();
        }
        
        if (data.warrant) {
          const warrantSelect = $('#warrant');
          if (warrantSelect) warrantSelect.value = data.warrant;
        }
        
        if (data.glSplitAllocations && Array.isArray(data.glSplitAllocations)) {
          glSplitAllocations = data.glSplitAllocations;
          // Rebuild GL split UI
          if (currentEmployee && GL_SPLIT_EMPLOYEES.includes(currentEmployee.name)) {
            const container = $('#glSplitContainer');
            if (container) {
              container.innerHTML = '';
              data.glSplitAllocations.forEach(alloc => {
                addGLSplitRow();
                const lastRow = container.lastElementChild;
                if (lastRow) {
                  const accountSelect = lastRow.querySelector('.gl-split-account');
                  const hoursInput = lastRow.querySelector('.gl-split-hours');
                  if (accountSelect) accountSelect.value = alloc.account;
                  if (hoursInput) hoursInput.value = alloc.hours;
                }
              });
              validateGLSplit();
            }
          }
        }
        
        setMsg('Previous work restored', 'success');
      }
    } catch (error) {
      console.error('Error loading saved data:', error);
    }
  }

  // ---- Form Submission ----
  async function handleSubmit(e) {
    e.preventDefault();
    
    if (!currentEmployee) { 
      setMsg("Please select an employee.", "error", true); 
      return; 
    }
    if (!currentWarrant) { 
      setMsg("Please select a pay period.", "error", true); 
      return; 
    }

    // Validate GL split for applicable employees
    if (currentEmployee && GL_SPLIT_EMPLOYEES.includes(currentEmployee.name)) {
      if (!validateGLSplit()) {
        setMsg("Please ensure all hours are properly allocated to GL accounts before submitting.", "error", true);
        return;
      }
    }

    const entries = [];
    const rows = Array.from(document.querySelectorAll('#timeBody tr'));
    rows.forEach(row => {
      const date = row.querySelector('.date-cell')?.value || '';
      const start = row.querySelector('.time-start')?.value || '';
      const end = row.querySelector('.time-end')?.value || '';
      const hours = parseFloat(row.querySelector('.time-hours')?.value || 0) || 0;
      const type = row.querySelector('.time-type')?.value || 'Regular';
      const gl = row.querySelector('.gl-input')?.value || '';
      const desc = row.children[6]?.querySelector('input')?.value || '';
      if (date && hours > 0) {
        entries.push({ date, start, end, hours, type, gl, description: desc });
      }
    });

    if (!entries.length) { 
      setMsg("Add at least one time entry.", "error", true); 
      return; 
    }

    const totals = {
      totalHours: parseFloat(document.getElementById('totalHours')?.textContent || 0),
      regularHours: parseFloat(document.getElementById('sumRegular')?.textContent || 0),
      sickHours: parseFloat(document.getElementById('sumSick')?.textContent || 0),
      personalHours: parseFloat(document.getElementById('sumPersonal')?.textContent || 0),
      vacationHours: parseFloat(document.getElementById('sumVacation')?.textContent || 0),
      holidayHours: parseFloat(document.getElementById('sumHoliday')?.textContent || 0),
      grossPay: document.getElementById('grossPay')?.textContent || "$0.00"
    };

    const payload = {
      meta: {
        submittedAt: new Date().toISOString(),
        notify: NOTIFY,
        source: "HubbTIME (Ultimate)",
        hasGLSplit: GL_SPLIT_EMPLOYEES.includes(currentEmployee.name)
      },
      employee: {
        name: currentEmployee.name,
        department: currentEmployee.department,
        payType: currentEmployee.payType,
        rate: currentEmployee.rate,
        position: currentEmployee.position || null,
        email: currentEmployee.email || 'admin@hubbardstonma.gov'
      },
      warrant: currentWarrant,
      entries,
      totals,
      glSplitAllocations: GL_SPLIT_EMPLOYEES.includes(currentEmployee.name) ? glSplitAllocations : null
    };

    const btn = document.getElementById('submitBtn');
    const status = document.getElementById('submitStatus');
    try {
      if (btn) btn.disabled = true;
      if (status) status.textContent = 'Sending to payroll…';
      setMsg('Submitting timesheet…', 'info', true);

      const res = await fetch(FLOW_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (!res.ok) throw new Error('Submission failed with status ' + res.status);

      setMsg('Timesheet submitted successfully.', 'success', true);
      if (status) status.textContent = 'Submitted ✓';
      
      // Clear saved data after successful submission
      localStorage.removeItem('hubbtime_data');
      
      // Reset form after a delay
      setTimeout(() => {
        if (confirm('Timesheet submitted successfully! Would you like to start a new timesheet?')) {
          resetForm();
        }
      }, 2000);
      
    } catch (err) {
      console.error(err);
      setMsg('Error submitting timesheet: ' + err.message, 'error', true);
      if (status) status.textContent = 'There was a problem submitting. Please try again.';
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  function resetForm() {
    clearEmployee();
    const warrantSelect = $('#warrant');
    if (warrantSelect) warrantSelect.value = '';
    currentWarrant = null;
    clearAllRows();
    calculateTotals();
    setMsg('Ready for new timesheet', 'info');
  }

  // ---- Theme Toggle ----
  function initThemeToggle() {
    const themeToggle = $('#themeToggle');
    if (!themeToggle) return;

    // Get saved theme preference or default to dark
    const savedTheme = localStorage.getItem('hubbtime_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeButton(savedTheme);

    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('hubbtime_theme', newTheme);
      updateThemeButton(newTheme);
      
      // Update button pressed state for accessibility
      themeToggle.setAttribute('aria-pressed', newTheme === 'light');
    });
  }

  function updateThemeButton(theme) {
    const themeToggle = $('#themeToggle');
    if (!themeToggle) return;
    
    themeToggle.textContent = theme === 'dark' ? 'Light' : 'Dark';
    themeToggle.setAttribute('aria-pressed', theme === 'light');
  }

  // ---- Initialization ----
  function init() {
    // Populate employee datalist
    const employeeList = $('#employeeList');
    if (employeeList) {
      EMPLOYEES.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.name;
        option.label = `${emp.name} — ${emp.department}`;
        employeeList.appendChild(option);
      });
    }

    // Populate warrant select
    const warrantSelect = $('#warrant');
    if (warrantSelect) {
      WARRANTS.forEach(warrant => {
        const option = document.createElement('option');
        option.value = warrant.number;
        const startDate = new Date(warrant.start).toLocaleDateString();
        const endDate = new Date(warrant.end).toLocaleDateString();
        option.textContent = `Warrant ${warrant.number} (${startDate} - ${endDate})`;
        warrantSelect.appendChild(option);
      });
    }

    // Employee search handler
    const employeeSearch = $('#employeeSearch');
    if (employeeSearch) {
      employeeSearch.addEventListener('input', handleEmployeeSelection);
    }

    // Clear employee button
    const clearEmployeeBtn = $('#clearEmployeeBtn');
    if (clearEmployeeBtn) {
      clearEmployeeBtn.addEventListener('click', clearEmployee);
    }

    // Warrant selection handler
    if (warrantSelect) {
      warrantSelect.addEventListener('change', function() {
        const warrantNum = parseInt(this.value);
        currentWarrant = WARRANTS.find(w => w.number === warrantNum) || null;
        if (currentWarrant) {
          setMsg(`Selected pay period: ${currentWarrant.start} to ${currentWarrant.end}`, 'info', true);
        }
      });
    }

    // Quick action buttons
    const quickButtons = [
      { id: 'addRowBtn', handler: addTimeRow },
      { id: 'townHallBtn', handler: addTownHallHours },
      { id: 'splitShiftBtn', handler: addSplitShift },
      { id: 'overtimeBtn', handler: () => addQuickDay('Regular', 'Overtime Day', '12.00') },
      { id: 'sickBtn', handler: () => addQuickDay('Sick', 'Sick Day') },
      { id: 'personalBtn', handler: () => addQuickDay('Personal', 'Personal Day') },
      { id: 'vacationBtn', handler: () => addQuickDay('Vacation', 'Vacation Day') },
      { id: 'holidayBtn', handler: () => addQuickDay('Holiday', 'Holiday') },
      { id: 'clearAllBtn', handler: () => {
        if (confirm('Clear all time entries? This cannot be undone.')) {
          clearAllRows();
          setMsg('All entries cleared.', 'info', true);
        }
      }}
    ];

    quickButtons.forEach(({ id, handler }) => {
      const btn = document.getElementById(id);
      if (btn) btn.addEventListener('click', handler);
    });

    // GL Split add button
    const addGLAccountBtn = $('#addGLAccountBtn');
    if (addGLAccountBtn) {
      addGLAccountBtn.addEventListener('click', addGLSplitRow);
    }

    // Form submission
    const form = $('#timesheetForm');
    if (form) {
      form.addEventListener('submit', handleSubmit);
    }

    // Initialize theme toggle
    initThemeToggle();

    // Load saved data
    loadFromLocalStorage();

    // Add initial empty row
    addTimeRow();

    // Set initial message
    setMsg('HubbTIME system ready. Select an employee and pay period to begin.', 'info', true);
  }

  // ---- Public API ----
  return {
    init,
    addTimeRow,
    clearAllRows,
    calculateTotals,
    handleSubmit,
    addQuickDay,
    resetForm,
    removeGLSplitRow,
    
    // Expose for debugging
    get currentEmployee() { return currentEmployee; },
    get currentWarrant() { return currentWarrant; },
    get employees() { return EMPLOYEES; },
    get warrants() { return WARRANTS; },
    get glSplitAllocations() { return glSplitAllocations; }
  };
})();

// ---- Auto-initialize when DOM is ready ----
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    window.HubbTIME.init();
  });
} else {
  window.HubbTIME.init();
}

// ---- Keyboard shortcuts ----
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + Enter to add new row
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    window.HubbTIME.addTimeRow();
  }
  
  // Ctrl/Cmd + S to save (trigger auto-save)
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    // Auto-save is already handled by input events, just show indicator
    const indicator = document.getElementById('autoSaveIndicator');
    if (indicator) {
      indicator.style.opacity = '1';
      setTimeout(() => indicator.style.opacity = '0', 2000);
    }
  }
});

// ---- Service Worker Registration (Optional) ----
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // Uncomment to enable offline functionality
    // navigator.serviceWorker.register('/sw.js')
    //   .then(registration => console.log('SW registered'))
    //   .catch(registrationError => console.log('SW registration failed'));
  });
}
  </script>
</body>
</html>
